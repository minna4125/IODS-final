
---
title: "Anime recomendation with clustering and MCA analysis"
author: "Minna Peralampi"
date: "8.3.2017"
email: "minna.peralampi@helsinki.fi"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```
#Abstract

#Research questions
#####Can we predict if the anime is popular based on the number of episoeds, genres, members and type?
#####My hypothesis is that more episodes and members makes the anime more likely to be liked. 

##Link to the R-script
<https://github.com/minna4125/IODS-final/blob/master/create_anime.R>

       
#The data
#### The data is downloaded from kaggele (2.3.2017).
<https://www.kaggle.com/CooperUnion/anime-recommendations-database>
It orgins from myanimelist.net website.
Data is about animes ratings in myanimelist.net.

Variables in the data:
1.type is a factor variable which has values [Movie, TV, OVA, ONA, Special, TV]
2.episodes, which is the number of episodes anime has.
3.members is the number of people in the animes "fan group"
4.genre_clusters is the number of cluster that the animes genres belong to [1-5].
  1.Fantasy animes
  2.Horror/supernatural animes
  3.Funny animes
  4.Human relationships
  5.Mystery/sci-fi animes
  
5.Rating, an numeric variable with values 0, if the rating is equal or under 7.5/10 and 1 if it is over


Data modification
  1.Animes with NA values were removed (such as animes with no genre or type)
  2.44 genres were reduced to 5 clusters 
  3.Anime_ids were made to a rownames
  4.Rating was made into a binomial variable
  
#Variables
```{r, eval=TRUE}
    #Downloading the data
    anime <- read.csv("anime_gen")
    str(anime)
    
    #Drawing the type variable
    counts <- table(anime$rating, anime$type)
    barplot(counts , main="Anime types", xlab = "Purple = liked", col=c( "pink", "purple"))
  

    
    #Drawing the episodes variable


    #Drawing the members variable
    library(ggplot2)
    g2 <- ggplot(anime, aes(x = rating, y = members, group = rating, col=rating))

    # define the plot as a boxplot and draw it
    g2 + geom_boxplot() + ylab("members") + ggtitle("Members by popularity")+ xlim(-1,2)

```   

    
####Why the genres were made into cluster? 
######There was 44 diffrent genres in the data and over 2000 unique combination of these. It is too much variables to be used in this model, but I find genre to be one of the key elements in determing if the anime is being liked or not. So I decided to group these 2000 genres in reasonable amount of groups by clustering.
####How the number of clusters was determined? 
######I used kmeans function with nstart ( the number of random sets chosen) as 30, because I don't know where the centers are and 10 guesses weren't enough in my opinion. The  iterations was set to 10000 so it was enough too. Then I relied on human inteligence in valuing the number of clusters. I increased the number of clusters untill the genre combinations in each cluster seemed reasonable enough.
```{r, eval=TRUE}

    #Drawing the genre_cluster variable
    counts <- table(anime$rating, anime$genre_cluster)
    barplot(counts , main="Genre clusters", xlab = "Purple = liked", col=c( "pink", "purple"))
```  


#Logistic regression model
###### In this case, model tries to predict wether certain anime belongs to the category of liked (1) or not liked (0) based on the explanotory variables. 




    #Making the model
    #Reading the file (yes, a bubble gum fix)
    anime <- read.csv("anime_gen")
    anime <- filter(anime, complete.cases)
    
    #libraries
    library(dplyr)
    m <- glm(rating ~ episodes+members+type+genre_cluster, data = anime, family = "binomial")
    summary(m)
    
    #Computing the odds ratios (OR)
    OR <- coef(m) %>% exp

    #Computing the confidence intervals (CI)
    CI <- confint(m) %>% exp
    

    #Printing out the odds ratios with their confidence intervals
    cbind(OR, CI)

    #Predicting (with predict()) the probability of anime being liked
    probabilities <- predict(m, type = "response")

    #Adding the probabilities  to anime
    anime <- mutate(anime, probability = probabilities)

    #Using the probabilities to make a prediction of anime being liked
    anime <- mutate(anime, prediction = anime$probability > .5)

    #Tabulating the target variable vs. the predictions
    table(rating = anime$rating, prediction = anime$probability > .5 )
    
    #Tabulating the target variable against the prediction
    table(rating = anime$rating, prediction = anime$prediction) %>% prop.table()%>%       addmargins()



    
    #Making a loss function in another words the average prediction error
    loss_func <- function(class, prob) {
    n_wrong <- abs(class - prob) > 0.5
    mean(n_wrong)
    }

    # compute the average number of wrong predictions in the (training) data
    loss_func(anime$rating, anime$probability)

    #K-fold cross-validation
    library(boot)
    cv <- cv.glm(data = anime, cost = loss_func, glmfit = m, K = 10)

    #Average number of wrong predictions in the cross validation
    cv$delta[1]
    library(dplyr)
    
    
    #Drawing the results
    counts2 <- table(anime$rating, anime$prediction)
    barplot(counts2 , main="Prediction vs. actual", xlab = "Black = wrong prediction", col=c( "yellow", "black"),beside = T)



#Making the model and validating it

```{r, eval=TRUE, warning=FALSE}


   
    #Adding libraries
    library(dplyr)
    library(tidyr)
    
  

    #Making the model
    m <- glm(rating ~ episodes+members+genre_cluster+type, data = anime, family = "binomial")
    summary(m)
```


##Model validation with odd ratios and their intervals
####From the oddsratios can be seen that
```{r, eval=TRUE}
    #Computing th odds ratios (OR)
    OR <- coef(m) %>% exp

    #Computing the confidence intervals (CI)
    CI <- confint(m) %>% exp

    #Printing out the odds ratios with their confidence intervals
     cbind(OR, CI)
```

##Model validation with cross tabulations

```{r, eval=TRUE}
    #Predicting with predict() the probability of anime being liked (=1)
    probabilities <- predict(m, type = "response")

     #Adding the predicted probabilities to 'anime'
     anime <- cbind(anime, probability = probabilities)
 
     #Using the probabilities to make a prediction of anime rating
    
     anime <- cbind(anime, prediction = anime$probability > .5)
 
     #Cross tabulating the target variable versus the predictions
     table(rating = anime$rating, prediction = anime$probability > .5 )
     
     #Same with precentages
     table(rating = anime$rating, prediction = anime$prediction) %>% prop.table()%>%       addmargins()
```

##Over all error of the model

```{r, eval=TRUE}
     
     #Defining a loss function to calculate average prediction error
     loss_func <- function(class, prob) {
     n_wrong <- abs(class - prob) > 0.5
     mean(n_wrong)
     }

    #Computing the average number of wrong predictions in the training data
     loss_func(anime$rating, anime$probability)
     
    #K-fold cross-validation
    library(boot)
    cv <- cv.glm(data = anime, cost = loss_func, glmfit = m, K = 10)
    
    #Average number of wrong predictions in the cross validation
     cv$delta[1]
     
    #Drawing the results 
    counts2 <- table(anime$rating, anime$prediction)
    barplot(counts2 , main="Prediction vs. actual", xlab = "Black = wrong prediction", col=c( "yellow", "black"),beside = T)

   

```    



